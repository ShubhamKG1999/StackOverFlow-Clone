{% extends 'base.html' %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // JavaScript for question vote
    $(document).ready(function () {
        // Fetch user's previous vote for question from server using AJAX
        $.ajax({
            url: '{% url 'get_user_vote' %}',  // Replace with your URL for fetching user's previous vote
            type: 'GET',
            data: { question_id: '{{ question.id }}' },  // Include question ID in request data
            success: function (data) {
                // Check/uncheck checkboxes based on user's previous vote
                if (data.vote_type === 1) {
                    $('#increase-question-checkbox').prop('checked', true);
                } else if (data.vote_type === -1) {
                    $('#decrease-question-checkbox').prop('checked', true);
                }
            },
            error: function () {
                console.error('Failed to fetch user vote for question.');
            }
        });

        // Send form data to server using AJAX when a checkbox is selected
        $('input[name=question_vote]').on('change', function (event) {
            event.preventDefault(); // Prevent form submission

            // Uncheck other checkboxes
            $('input[name=question_vote]').not(this).prop('checked', false);

            // Get selected vote option
            var vote = $('input[name=question_vote]:checked').val();

            // Get initial points value
            var initial_points = $('input[name=question_initial_points]').val();

            // Get CSRF token
            var csrf_token = $('input[name=csrfmiddlewaretoken]').val();

            // Send form data to server using AJAX
            $.ajax({
                url: $('#question-vote-form').attr('action'),
                type: $('#question-vote-form').attr('method'),
                data: { vote: vote, initial_points: initial_points }, // Include initial points value in request data
                headers: { 'X-CSRFToken': csrf_token }, // Include CSRF token in request headers
                success: function (data) {
                    // Update question points on success
                    $('#question-points').text(data.question_points);
                },
                error: function () {
                    alert('An error occurred while processing your vote for question. Please try again.');
                }
            });
        });
    });

    // JavaScript for answer vote
    // JavaScript for answer vote
    $(document).ready(function () {
        // Fetch user's previous vote for answer from server using AJAX
        $.ajax({
            url: '{% url 'get_user_vote' %}',  // Replace with your URL for fetching user's previous vote
            type: 'GET',
            data: { answer_id: '{{ answer.id }}' },  // Include answer ID in request data
            success: function (data) {
                // Check/uncheck checkboxes based on user's previous vote
                if (data.vote_type === 1) {
                    $('#increase-answer-checkbox').prop('checked', true);
                } else if (data.vote_type === -1) {
                    $('#decrease-answer-checkbox').prop('checked', true);
                }
            },
            error: function () {
                console.error('Failed to fetch user vote for answer.');
            }
        });

        // Send form data to server using AJAX when a checkbox is selected
        $('input[name=answer_vote]').on('change', function (event) {
            event.preventDefault(); // Prevent form submission

            // Get selected vote option
            var vote = $('input[name=answer_vote]:checked').val();

            // Get initial points value
            var initial_points = $('input[name=answer_initial_points]', $(this).closest('form')).val();

            // Get CSRF token
            var csrf_token = $('input[name=csrfmiddlewaretoken]', $(this).closest('form')).val();

            // Send form data to server using AJAX
            $.ajax({
                url: $(this).closest('form').attr('action'),
                type: $(this).closest('form').attr('method'),
                data: { vote: vote, initial_points: initial_points }, // Include initial points value in request data
                headers: { 'X-CSRFToken': csrf_token }, // Include CSRF token in request headers
                success: function (data) {
                    // Update answer points on success
                    $('#answer-points', $(this).closest('li')).text(data.answer_points);
                }.bind(this),
                error: function () {
                    alert('An error occurred while processing your vote for answer. Please try again.');
                }
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<h1>{{ question.title }}</h1>
<p>{{ question.description }}</p>
<p>Posted by: {{ question.user.username }}</p>
<p>Posted at: {{ question.created_at }}</p>
<p>Points: <span id="question-points">{{ question.points }}</span></p>



<!-- Question vote form -->
<form method="post" action="{% url 'vote_question' question_id=question.id %}" id="question-vote-form">
    {% csrf_token %}
    <label>
        <input type="checkbox" name="question_vote" value="increase" id="increase-question-checkbox"> Increase
    </label>
    <label>
        <input type="checkbox" name="question_vote" value="decrease" id="decrease-question-checkbox"> Decrease
    </label>
    <input type="hidden" name="initial_points" value="{{ question.points }}">
    <!-- Add a hidden input field to store the initial points value -->
</form>

<h2>Comments</h2>
<ul id="comments-list">
  {% for comment in comments %}
    <li>
      {{ comment.comment_text }}
      {% if request.user.is_authenticated and comment.user == request.user %}
        <form method="post" action="{% url 'delete_comment' comment.id %}">
          {% csrf_token %}
          <button type="submit">Delete</button>
        </form>
      {% endif %}
    </li>
  {% empty %}
    <li>No comments yet.</li>
  {% endfor %}
</ul>


<!-- Add comment form -->
<form method="post" action="{% url 'add_comment' question_id=question.id %}">
    {% csrf_token %}
    <input type="hidden" name="question_id" value="{{ question.id }}">
    <label for="comment-content">Comment:</label>
    <textarea id="comment-content" name="comment_content" rows="3"></textarea>
    <button type="submit">Add Comment</button>
</form>

{% if not user_answered %}

<!-- Add answer form -->
<h3>Add Answer</h3>
<form method="post" action="{% url 'add_answer' question_id=question.id %}">
    {% csrf_token %}
    <textarea name="answer_text" rows="4" cols="50"></textarea><br>
    <input type="submit" value="Answer">
</form>
{% else %}
<p>You have already answered this question.</p>
{% endif %}

<h3>Answers</h3>
<ul>
    {% for answer in answers %}
    <li>
        <p>{{ answer.answer_text }}</p>
        <p>Helpful: {{ answer.helpful }}</p>
        <p>Answered by: {{ answer.user.username }}</p>
        <p>Answered at: {{ answer.created_at }}</p>
        <p>Points: <span id="answer-points">{{ answer.points }}</span></p>

        <!-- Answer vote form -->
        <form method="post" action="{% url 'vote_answer' answer_id=answer.id %}" id="answer-vote-form">
            {% csrf_token %}
            <label>
                <input type="checkbox" name="answer_vote" value="increase" id="increase-answer-checkbox"> Increase
            </label>
            <label>
                <input type="checkbox" name="answer_vote" value="decrease" id="decrease-answer-checkbox"> Decrease
            </label>
            <input type="hidden" name="initial_points" value="{{ answer.points }}">
            <!-- Add a hidden input field to store the initial points value -->
        </form>
    </li>
    {% empty %}
    <li>No answers yet.</li>
    {% endfor %}
</ul>

<a href="{% url 'feed' %}">Back to Feed</a>
{% endblock %}